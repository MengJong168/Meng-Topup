<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MENG TOPUP</title>
  <link rel="shortcut icon" href="static\images\logo.jpg" type="icon/jpg" sizes="32x32" />
  <link rel="stylesheet" href="/static/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <header onclick="location.reload()">
    <div class="header-content">
      <img src="/static/images/logo.jpg" alt="MENG TOPUP Logo" class="header-logo" />
      <h1 class="header-title khmer-heading">MENG TOPUP</h1>
    </div>
  </header>

  <main>
    <!-- Modified Home Banner Section -->
<div class="home-banner frame">
  <div class="">
    <img src="/static/images/banner-01.jpg" alt="Meng Topup Banner" class="banner-image">
    <div class="banner-text">
      <h3 class="khmer-heading"></h3>
      <p class="khmer-heading"></p>
    </div>
  </div>
</div>
    <!-- Homepage Section -->
    <section id="homepage" class="homepage-section">
      <h2 class="section-title khmer-heading">á‡áŸ’ášá¾áŸášá¾áŸá áŸ’á‚áŸá˜áŠáŸ‚á›á¢áŸ’á“á€á…á„áŸ‹á‘á·á‰á–áŸá‡áŸ’á™</h2>
      <div class="game-grid">
        <div class="game-card" onclick="showMLTopup()">
          <div class="game-image-container">
            <img src="/static/images/mobile_legend.jpg" alt="Mobile Legend" class="game-image"/>
          </div>
          <div class="game-title khmer-heading">MOBILE LEGEND</div>
          <button class="khmer-heading">TOPUP</button>
        </div>
        <div class="game-card" onclick="showFFTopup()">
          <div class="game-image-container">
            <img src="/static/images/free_fire.jpg" alt="Free Fire" class="game-image"/>
          </div>
          <div class="game-title khmer-heading">FREE FIRE</div>
          <button class="khmer-heading">TOPUP</button>
        </div>
      </div>
    </section>
<!-- Terms and Conditions Section (initially hidden) -->
<section id="termsSection" style="display: none;">
  <div class="frame">
    <h2 class="khmer-heading" style="margin-bottom: 15px;">Terms & Condition</h2>
    <p class="khmer-heading">áŸ¡. ááŸ’á‰á»áŸ†á™á›áŸ‹á–áŸ’ášá˜á…áŸ†á–áŸ„áŸ‡á€á¶ášá”á‰áŸ’á‡á¶ášá‘á·á‰á‘á¶áŸ†á„á¢áŸáŸ‹ á“á·á„á˜á·á“á˜á¶á“á€á¶ášâ€‹ á›á»á”á…áŸ„á› á¬â€‹ áŸá„á”áŸ’ášá¶á€áŸ‹áœá·á‰ á¡á¾á™</p>
    <p class="khmer-heading">1. I agree to all orders and there is no cancellation or refund</p>
    <button onclick="hideTerms()" class="khmer-heading" style="margin-top: 20px;">Back</button>
  </div>
</section>

    <!-- Mobile Legends Topup Section (initially hidden) -->
    <section id="mlTopupSection" style="display: none;">
      <section class="banner frame">
        <div class="banner-content">
          <div class="game-title-container">
            <img src="/static/images/mlbb-logo1.png" alt="Mobile Legends Logo" class="game-logo" />
            <h3 class="khmer-heading">Mobile Legend BANG BANG</h3>
          </div>
          <h3 class="khmer-heading">á‘á·á‰á–áŸá‡áŸ’áš Mobile Legends: Bang Bang á€áŸ’á“á»á„áá˜áŸ’á›áŸƒáŸá˜ášá˜áŸ’á™!</h3>
        </div>
      </section>

      <h3 class="khmer-heading">1. á”á‰áŸ’á…á¼á›á–áŸááŸŒá˜á¶á“</h3>
      <section class="user-input frame">
        <div class="input-row">
          <input type="number" id="idInput" placeholder="Player ID" />
          <input type="number" id="zoneInput" placeholder="Zone ID" />
        </div>
        <button onclick="checkUsername()">Check Username</button>
        <div id="usernameDisplay" class="khmer-heading"></div>
      </section>

      <section>
        <h3 class="khmer-heading">2. á‡áŸ’ášá¾áŸášá¾áŸá€á‰áŸ’á…á”áŸ‹</h3>
        <div class="frame">
          <div class="pricing-grid" id="packageGrid"></div>
        </div>
      </section>

      <section>
        <h3 class="khmer-heading">3.â€‹á€á¶ášá‘á¼á‘á¶ááŸ‹á”áŸ’ášá¶á€áŸ‹</h3>
        <div class="khqr-card" id="khqrCard">
          <h3 class="khmer-heading">KHQR</h3>
          <div class="text-group">
          </div>
          <h6>Scan to pay with any banking app</h6>
          <input type="checkbox" id="khqrCheck" />
        </div>
      </section>
      <!-- Step 4: Agreement -->
<section>
  <h3 class="khmer-heading"></h3>
  <div class="frame-agreement">
    <label class="khmer-heading" style="display: flex; align-items: center; gap: 10px;">
      <input type="checkbox" id="mlAgreementCheck" />
      ááŸ’á‰á»áŸ†á™á›áŸ‹á–áŸ’ášá˜áá¶á˜ 
      <a href="javascript:void(0)" onclick="showTerms('ml')" style="color: #ffe600; text-decoration: underline;">
        á›á€áŸ’ááááŸ’áŒ
      </a>
    </label>
  </div>
</section>

      <section class="banner frame">
        <div class="banner-content">
          <div class="game-title">
            <img src="/static/images/logo.jpg" alt="Mobile Legends Logo" class="ml-logo" />
            <h3 class="khmer-heading">á áŸáá»á¢áŸ’áœá¸á¢áŸ’á“á€á‚á½ášá‡áŸ’ášá¾áŸášá¾áŸ MENG TOPUP á’áŸ’áœá¾á‡á¶á€á“áŸ’á›áŸ‚á„á”á‰áŸ’á…á¼á›á–áŸá‡áŸ’ášá áŸ’á‚áŸá˜ášá”áŸáŸ‹á¢áŸ’á“á€?</h3>
          </div>
          <h4 class="khmer-heading">áá˜áŸ’á›áŸƒáŸá˜ášá˜áŸ’á™ áŸá»áœááŸ’áá·á—á¶á– á“á·á„ á‘áŸ†á“á»á€á…á·ááŸ’á áŸáŸáœá¶á€á˜áŸ’á˜ášá áŸáŸ</h4>
        </div>
      </section>
    </section>

    <!-- Free Fire Topup Section (initially hidden) -->
    <section id="ffTopupSection" style="display: none;">
      <section class="banner frame">
        <div class="banner-content">
          <div class="game-title-container">
            <img src="/static/images/ff-logo.jpg" alt="Free Fire Logo" class="game-logo" />
            <h3 class="khmer-heading">FREE FIRE</h3>
          </div>
          <h3 class="khmer-heading">á‘á·á‰á–áŸá‡áŸ’áš Free Fire á€áŸ’á“á»á„áá˜áŸ’á›áŸƒáŸá˜ášá˜áŸ’á™!</h3>
        </div>
      </section>

      <h3 class="khmer-heading">1. á”á‰áŸ’á…á¼á›á–áŸááŸŒá˜á¶á“</h3>
<section class="user-input frame ff-check-wrapper">
  <div class="ff-input-group">
    <input type="number" id="ffIdInput" placeholder="Player ID" class="ff-input" />
    <button onclick="checkFFUsername()" class="ff-check-button">Check Username</button>
  </div>
  <div id="ffUsernameDisplay" class="khmer-heading ff-username-result"></div>
</section>

      <section>
        <h3 class="khmer-heading">2. á‡áŸ’ášá¾áŸášá¾áŸá€á‰áŸ’á…á”áŸ‹</h3>
        <div class="frame">
          <div class="pricing-grid" id="ffPackageGrid"></div>
        </div>
      </section>

      <section>
        <h3 class="khmer-heading">3.â€‹á€á¶ášá‘á¼á‘á¶ááŸ‹á”áŸ’ášá¶á€áŸ‹</h3>
        <div class="khqr-card" id="ffKhqrCard">
          <h3 class="khmer-heading">KHQR</h3>
          <div class="text-group">
          </div>
          <h6>Scan to pay with any banking app</h6>
          <input type="checkbox" id="ffKhqrCheck" />
        </div>
      </section>
      <!-- Step 4: Agreement -->
<section>
  <h3 class="khmer-heading"></h3>
  <div class="frame-agreement">
    <label class="khmer-heading" style="display: flex; align-items: center; gap: 10px;">
      <input type="checkbox" id="ffAgreementCheck" />
      ááŸ’á‰á»áŸ†á™á›áŸ‹á–áŸ’ášá˜áá¶á˜ 
      <a href="javascript:void(0)" onclick="showTerms('ff')" style="color: #ffe600; text-decoration: underline;">
        á›á€áŸ’ááááŸ’áŒ
      </a>
    </label>
  </div>
</section>

      
      <section class="banner frame">
        <div class="banner-content">
          <div class="game-title">
            <img src="/static/images/logo.jpg" alt="Free Fire Logo" class="ff-logo" />
            <h3 class="khmer-heading">á áŸáá»á¢áŸ’áœá¸á¢áŸ’á“á€á‚á½ášá‡áŸ’ášá¾áŸášá¾áŸ MENG TOPUP á’áŸ’áœá¾á‡á¶á€á“áŸ’á›áŸ‚á„á”á‰áŸ’á…á¼á›á–áŸá‡áŸ’ášá áŸ’á‚áŸá˜ášá”áŸáŸ‹á¢áŸ’á“á€?</h3>
          </div>
          <h4 class="khmer-heading">áá˜áŸ’á›áŸƒáŸá˜ášá˜áŸ’á™ áŸá»áœááŸ’áá·á—á¶á– á“á·á„ á‘áŸ†á“á»á€á…á·ááŸ’á áŸáŸáœá¶á€á˜áŸ’á˜ášá áŸáŸ</h4>
        </div>
      </section>
    </section>
  </main>

  <footer id="mainFooter" class="site-footer">
    <div class="footer-content">
      <div class="footer-section">
        <h3 class="khmer-heading">á¢áŸ†á–á¸á™á¾á„</h3>
        <p class="khmer-heading">MENG TOPUP á•áŸ’áá›áŸ‹áŸáŸáœá¶á€á˜áŸ’á˜á”á‰áŸ’á…á¼á›á–áŸá‡áŸ’ášá›áŸ’á¢á”áŸ†á•á»á</p>
      </div>
      <div class="footer-section">
        <h3 class="khmer-heading">áœá·á’á¸á”á„áŸ‹á”áŸ’ášá¶á€áŸ‹</h3>
        <p class="khmer-heading">á™á¾á„á‘á‘á½á›á€á¶ášá”á„áŸ‹á”áŸ’ášá¶á€áŸ‹áá¶á˜ášá™áŸˆ KHQR</p>
      </div>
      <div class="footer-section">
        <h3 class="khmer-heading">á‘áŸ†á“á¶á€áŸ‹á‘áŸ†á“á„</h3>
        <p class="khmer-heading">Telegram: @MENGTOPUPP</p>
      </div>
    </div>
    <div class="footer-bottom">
      <p class="khmer-heading">Copyright Â© MENG TOPUP. All Rights Reserved.</p>
      <p class="khmer-heading" style="text-align: center; margin-top: 20px;">
      <a href="javascript:void(0)" onclick="showTerms()" style="color: #ffe600; text-decoration: underline;">
        Privacy Policy | Terms and Conditions
      </a>
    </p>
    </div>
  </footer>

  <button onclick="initiatePayment()" id="buyNowBtn" style="display: none;" class="khmer-heading">Buy Now $0.00</button>

  <!-- Bakong Payment Modal -->
  <div id="bakongModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 class="khmer-heading">Bakong Payment</h2>
      <div id="bakongStatus" class="khmer-heading">Ready to generate payment QR</div>
      
      <div class="qr-container">
        <div class="qr-image">
          <img id="bakongQR" src="" alt="QR Code">
        </div>
      </div>
      
      <div id="bakongCountdown" class="khmer-heading"></div>
      
      <div class="modal-buttons">
        <button id="checkPaymentBtn" class="bakong-btn khmer-heading" onclick="checkBakongPayment()" disabled>Check Payment</button>
        <button class="bakong-btn khmer-heading" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeInvoiceModal()">&times;</span>
      <h2 class="khmer-heading">Payment Successful</h2>
      
      <div class="invoice-details">
        <div class="invoice-row">
          <span class="invoice-icon">ğŸ‘¤</span>
          <span class="invoice-label khmer-heading">Username:</span>
          <span class="invoice-value khmer-heading" id="invoice-username"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">ğŸ†”</span>
          <span class="invoice-label khmer-heading">Player ID:</span>
          <span class="invoice-value khmer-heading" id="invoice-playerid"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">ğŸŒ</span>
          <span class="invoice-label khmer-heading">Zone ID:</span>
          <span class="invoice-value khmer-heading" id="invoice-zoneid"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">ğŸ®</span>
          <span class="invoice-label khmer-heading">Package:</span>
          <span class="invoice-value khmer-heading" id="invoice-package"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">ğŸ’µ</span>
          <span class="invoice-label khmer-heading">Amount:</span>
          <span class="invoice-value khmer-heading" id="invoice-amount"></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-icon">ğŸ“…</span>
          <span class="invoice-label khmer-heading">Date:</span>
          <span class="invoice-value khmer-heading" id="invoice-date"></span>
        </div>
      </div>
      
      <div class="modal-buttons">
  <button class="bakong-btn khmer-heading" onclick="downloadInvoicePDF()">Download Receipt</button>
  <button class="bakong-btn khmer-heading" onclick="backToTopup()">Back to Top-up</button>
</div>

  </div>

  <script>
    const packages = [
      { name: "11", price: 0.01 }, { name: "22", price: 0.50 }, { name: "86", price: 1.25 },
      { name: "172", price: 2.45 }, { name: "257", price: 3.50 }, { name: "343", price: 4.63 },
      { name: "429", price: 5.70 }, { name: "514", price: 6.80 }, { name: "600", price: 7.90 },
      { name: "706", price: 9.10 }, { name: "792", price: 9.95 }, { name: "878", price: 12.10 },
      { name: "963", price: 12.10 }, { name: "1050", price: 13.40 }, { name: "1135", price: 14.42 },
      { name: "1412", price: 17.80 }, { name: "1584", price: 19.99 }, { name: "1755", price: 23.28 },
      { name: "1926", price: 24.89 }, { name: "2195", price: 27.37 }, { name: "2538", price: 31.60 },
      { name: "2901", price: 35.72 }, { name: "4394", price: 52.80 }, { name: "5532", price: 65.80 },
      { name: "6238", price: 77.15 }, { name: "6944", price: 85.50 }, { name: "8433", price: 0.00 },
      { name: "9288", price: 116.00 }, 
      { name: "Weekly", price: 1.40, image: "mlweekly.jpg" }, 
      { name: "2Weekly", price: 2.80, image: "mlweekly.jpg" },
      { name: "3Weekly", price: 4.20, image: "mlweekly.jpg" }, 
      { name: "4Weekly", price: 5.60, image: "mlweekly.jpg" }, 
      { name: "5Weekly", price: 7.00, image: "mlweekly.jpg" },
      { name: "Twilight", price: 7.35, image: "starlight.jpg" },
    ];

    const ffPackages = [
      { name: "25", price: 0.01 }, { name: "100", price: 0.87 }, { name: "310", price: 2.47 },
      { name: "520", price: 4.18 }, { name: "1060", price: 8.03 }, { name: "2180", price: 16.25 },
      { name: "5600", price: 40.80 }, { name: "11500", price: 84.50 }, { name: "Weekly", price: 1.40, image: "ffweekly.jpg" },
      { name: "Weeklylite", price: 0.34, image: "ffweeklylite.jpg" }, { name: "Monthly", price: 6.83, image: "ffmonthly.jpg" },
      { name: "Evo3D", price: 0.56, image: "ffevo.jpg" }, { name: "Evo7D", price: 0.83, image: "ffevo.jpg" },
      { name: "Evo30D", price: 2.27, image: "ffevo.jpg" }
    ];

    // Initialize package grids when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Mobile Legends packages
      const grid = document.getElementById("packageGrid");
      packages.forEach(pkg => {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.name = pkg.name;
        card.dataset.price = pkg.price;
        card.innerHTML = `
          <img src="/static/images/${pkg.image || 'ml-diamond.jpg'}" alt="ml-Diamond" />
          <h2 class="khmer-heading">${pkg.name} ${pkg.name.includes('Weekly') ? 'Pass' : 'Diamonds'}</h2>
          <p class="new-price khmer-heading">$${pkg.price.toFixed(2)}</p>
        `;
        card.onclick = () => {
          document.querySelectorAll('#packageGrid .card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          selectedPrice = pkg.price;
          selectedName = pkg.name;
          document.getElementById('buyNowBtn').textContent = `Buy Now $${selectedPrice.toFixed(2)}`;
        };
        grid.appendChild(card);
      });

      // Free Fire packages
      const ffGrid = document.getElementById("ffPackageGrid");
      ffPackages.forEach(pkg => {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.name = pkg.name;
        card.dataset.price = pkg.price;
        card.innerHTML = `
          <img src="/static/images/${pkg.image || 'ff-diamond.jpg'}" alt="ff-Diamond" />
          <h2 class="khmer-heading">${pkg.name} ${pkg.name.includes('Weekly') || pkg.name.includes('lite') || pkg.name.includes('Monthly') || pkg.name.includes('Evo') || pkg.name.includes('Levelpass') ? '' : 'Diamonds'}</h2>
          <p class="new-price khmer-heading">$${pkg.price.toFixed(2)}</p>
        `;
        card.onclick = () => {
          document.querySelectorAll('#ffPackageGrid .card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          selectedPrice = pkg.price;
          selectedName = pkg.name;
          document.getElementById('buyNowBtn').textContent = `Buy Now $${selectedPrice.toFixed(2)}`;
        };
        ffGrid.appendChild(card);
      });
    });

    let selectedPrice = 0;
    let selectedName = "";
    let currentTransaction = null;
    let countdownInterval = null;

    function showMLTopup() {
      document.getElementById('homepage').style.display = 'none';
      document.getElementById('mlTopupSection').style.display = 'block';
      document.getElementById('ffTopupSection').style.display = 'none';
      document.getElementById('buyNowBtn').style.display = 'block';
      document.getElementById('mainFooter').style.display = 'none';
      window.scrollTo(0, 0);
      selectedPrice = 0;
      selectedName = "";
      document.getElementById('buyNowBtn').textContent = 'Buy Now $0.00';
    }

    function showFFTopup() {
      document.getElementById('homepage').style.display = 'none';
      document.getElementById('ffTopupSection').style.display = 'block';
      document.getElementById('mlTopupSection').style.display = 'none';
      document.getElementById('buyNowBtn').style.display = 'block';
      document.getElementById('mainFooter').style.display = 'none';
      window.scrollTo(0, 0);
      selectedPrice = 0;
      selectedName = "";
      document.getElementById('buyNowBtn').textContent = 'Buy Now $0.00';
    }

    async function checkUsername() {
      const id = document.getElementById('idInput').value.trim();
      const zone = document.getElementById('zoneInput').value.trim();
      const display = document.getElementById('usernameDisplay');
      if (!id || !zone) {
        display.textContent = "username not found!.";
        return;
      }
      display.textContent = "Checking username...";
      try {
        const url = `https://api.isan.eu.org/nickname/ml?id=${encodeURIComponent(id)}&zone=${encodeURIComponent(zone)}`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.success && data.name) {
          display.textContent = `âœ… Username: ${data.name}`;
        } else {
          display.textContent = "âŒ Username not found.";
        }
      } catch (err) {
        display.textContent = "âš ï¸ Error fetching data.";
      }
    }

    function openModal() {
      document.getElementById('bakongModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('bakongModal').style.display = 'none';
      if (countdownInterval) clearInterval(countdownInterval);
      currentTransaction = null;
    }

    function closeInvoiceModal() {
      document.getElementById('invoiceModal').style.display = 'none';
    }

    function initiatePayment() {
  let id, zone, isML = false, isFF = false;

  /* 1.  Identify which game section is active */
  if (document.getElementById('mlTopupSection').style.display === 'block') {
    isML = true;
    id   = document.getElementById('idInput').value.trim();
    zone = document.getElementById('zoneInput').value.trim();
  } else if (document.getElementById('ffTopupSection').style.display === 'block') {
    isFF = true;
    id   = document.getElementById('ffIdInput').value.trim();
    zone = "0";          // Free Fire has no zone
  }

  /* 2.  KHQR checkbox */
  const khqr = isML
    ? document.getElementById('khqrCheck').checked
    : document.getElementById('ffKhqrCheck').checked;

  /* 3.  Agreement checkbox */
  const agreed = isML
    ? document.getElementById('mlAgreementCheck').checked
    : document.getElementById('ffAgreementCheck').checked;

  /* 4.  Validations */
  if (!id) {
    alert('Please fill Player ID.');
    return;
  }

  if (!selectedName) {
    alert('Please select a package.');
    return;
  }

  if (!khqr) {
    alert('Please check KHQR payment method.');
    return;
  }

  if (!agreed) {
    alert('áŸá¼á˜á’áŸ’áœá¾á€á¶ášá™á›áŸ‹á–áŸ’ášá˜á“á¹á„á›á€áŸ’ááááŸ’áŒá˜á»á“á–áŸá›á”á“áŸ’á!');  // â€œPlease agree to the Terms before continuing!â€
    return;
  }

  /* 5.  All good â†’ open payment modal */
  openModal();
  generateBakongQR(id, zone);
}

  
    async function generateBakongQR(playerId, zoneId) {
  try {
    const gameType = document.getElementById('mlTopupSection').style.display === 'block' ? 'ml' : 'ff';
    
    const response = await fetch('/generate_qr', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        amount: selectedPrice,
        player_id: playerId,
        zone_id: zoneId,
        package: selectedName,
        game_type: gameType  // Add this line
      })
    });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || 'Failed to generate QR');
        }
        
        // Store current transaction
        currentTransaction = {
          id: result.transaction_id,
          amount: result.amount,
          expiry: new Date(result.expiry),
          playerId: playerId,
          zoneId: zoneId,
          package: selectedName
        };
        
        // Display QR code
        document.getElementById('bakongQR').src = `data:image/png;base64,${result.qr_image}`;
        
        // Enable check button
        document.getElementById('checkPaymentBtn').disabled = false;
        
        // Update status
        document.getElementById('bakongStatus').textContent = `Scan to pay $${selectedPrice.toFixed(2)}`;
        
        // Start countdown
        startCountdown();
        
      } catch (error) {
        document.getElementById('bakongStatus').textContent = `Error: ${error.message}`;
        document.getElementById('bakongStatus').style.color = '#f44336';
        console.error(error);
      }
    }

    function startCountdown() {
      if (countdownInterval) clearInterval(countdownInterval);
      updateCountdown();
      countdownInterval = setInterval(updateCountdown, 1000);
    }

    function updateCountdown() {
      if (!currentTransaction) return;
      
      const now = new Date();
      const remaining = currentTransaction.expiry - now;
      
      if (remaining <= 0) {
        clearInterval(countdownInterval);
        document.getElementById('bakongCountdown').textContent = 'QR Code Expired';
        document.getElementById('bakongCountdown').style.color = '#f44336';
        document.getElementById('checkPaymentBtn').disabled = true;
        document.getElementById('bakongStatus').textContent = 'QR expired. Please try again.';
        return;
      }
      
      const mins = Math.floor(remaining / 60000);
      const secs = Math.floor((remaining % 60000) / 1000);
      const countdownText = `Expires in: ${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      
      document.getElementById('bakongCountdown').textContent = countdownText;
      document.getElementById('bakongCountdown').style.color = (mins === 0 && secs < 30) ? '#f44336' : 'white';
    }

    async function checkBakongPayment() {
      if (!currentTransaction) {
        alert('No active transaction to check');
        return;
      }
      
      // Disable button during check
      document.getElementById('checkPaymentBtn').disabled = true;
      document.getElementById('bakongStatus').textContent = 'Checking payment...';
      
      try {
        const response = await fetch('/check_payment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            transaction_id: currentTransaction.id
          })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || 'Payment check failed');
        }
        
        if (result.status === 'PAID') {
          // Payment successful
          clearInterval(countdownInterval);
          document.getElementById('bakongCountdown').textContent = 'Payment Received!';
          document.getElementById('bakongCountdown').style.color = '#4caf50';
          document.getElementById('bakongStatus').textContent = result.message;
          
          // Show invoice
          showInvoice(currentTransaction);
          
          // Close payment modal after 0.5 second
          setTimeout(closeModal, 500);
        } else if (result.status === 'EXPIRED') {
          clearInterval(countdownInterval);
          document.getElementById('bakongCountdown').textContent = 'QR Code Expired';
          document.getElementById('bakongCountdown').style.color = '#f44336';
          document.getElementById('bakongStatus').textContent = result.message;
        } else {
          document.getElementById('bakongStatus').textContent = result.message;
          document.getElementById('checkPaymentBtn').disabled = false;
        }
      } catch (error) {
        document.getElementById('bakongStatus').textContent = `Error: ${error.message}`;
        document.getElementById('bakongStatus').style.color = '#f44336';
        document.getElementById('checkPaymentBtn').disabled = false;
        console.error(error);
      }
    }

    function showInvoice(transaction) {
  const now = new Date();
  let username = "N/A";

  // Determine which section is active and extract the username
  if (document.getElementById('mlTopupSection').style.display === 'block') {
    username = document.getElementById('usernameDisplay').textContent;
    if (username.includes('âœ… Username: ')) {
      username = username.replace('âœ… Username: ', '');
    }
  } else if (document.getElementById('ffTopupSection').style.display === 'block') {
    username = document.getElementById('ffUsernameDisplay').textContent;
    if (username.includes('âœ… Username: ')) {
      username = username.replace('âœ… Username: ', '');
    }
  }

  // Fill invoice details
  document.getElementById('invoice-username').textContent = username || 'N/A';
  document.getElementById('invoice-playerid').textContent = transaction.playerId;
  document.getElementById('invoice-zoneid').textContent = transaction.zoneId;
  document.getElementById('invoice-package').textContent = transaction.package;
  document.getElementById('invoice-amount').textContent = `$${transaction.amount.toFixed(2)}`;
  document.getElementById('invoice-date').textContent = now.toLocaleString();

  // Show the invoice modal
  document.getElementById('invoiceModal').style.display = 'flex';
}
    function backToTopup() {
      closeInvoiceModal();
      
      // Reset form
      if (document.getElementById('mlTopupSection').style.display === 'block') {
        document.getElementById('idInput').value = '';
        document.getElementById('zoneInput').value = '';
        document.getElementById('usernameDisplay').textContent = '';
        document.getElementById('khqrCheck').checked = false;
      } else {
        document.getElementById('ffIdInput').value = '';
        document.getElementById('ffKhqrCheck').checked = false;
      }
      
      // Reset package selection
      if (document.getElementById('mlTopupSection').style.display === 'block') {
        document.querySelectorAll('#packageGrid .card').forEach(c => c.classList.remove('selected'));
      } else {
        document.querySelectorAll('#ffPackageGrid .card').forEach(c => c.classList.remove('selected'));
      }
      
      document.getElementById('buyNowBtn').textContent = 'Buy Now $0.00';
      
      // Scroll to top
      window.scrollTo(0, 0);
    }
    async function checkFFUsername() {
  const uid = document.getElementById('ffIdInput').value.trim();
  const display = document.getElementById('ffUsernameDisplay');

  if (!uid) {
    display.textContent = "âŒ Please enter a Player ID.";
    display.style.color = "white";
    return;
  }

  display.textContent = "Checking username...";
  display.style.color = "white";

  try {
    const proxyUrl = 'https://api.allorigins.win/raw?url=';
    const targetUrl = encodeURIComponent(`https://wlx-ban-check.vercel.app/get_region?uid=${uid}`);
    const response = await fetch(proxyUrl + targetUrl);

    if (!response.ok) throw new Error("Network response was not ok");

    const data = await response.json();

    if (data.nickname) {
      display.textContent = `âœ… Username: ${data.nickname}`;
      display.style.color = "white";
    } else {
      display.textContent = "âŒ Username not found.";
      display.style.color = "white";
    }
  } catch (error) {
    display.textContent = "âš ï¸ Error fetching username.";
    display.style.color = "white";
    console.error(error);
  }
}

  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
async function downloadInvoicePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");
  const pw = doc.internal.pageSize.getWidth();

  const nowStr = document.getElementById("invoice-date").textContent;
  const dateOnly = nowStr.split(",")[0].trim();
  const timeOnly = nowStr.split(",")[1] ? nowStr.split(",")[1].trim() : "";

  const playerId = document.getElementById("invoice-playerid").textContent;
  const zoneId = document.getElementById("invoice-zoneid").textContent;
  const pkg = document.getElementById("invoice-package").textContent;
  const priceStr = document.getElementById("invoice-amount").textContent;

  // Generate invoice number with seconds (INVNO-YYYYMMDDHHMMSS)
  const now = new Date();
  const invoiceNumber = `INVNO-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;

  const logo = new Image();
  logo.src = "/static/images/logo.jpg";

  logo.onload = () => {
    // Logo
    doc.addImage(logo, "JPEG", 15, 12, 22, 20);

    // Company name
    doc.setFont("Helvetica", "bold");
    doc.setFontSize(12);
    doc.text("MENG TOPUP", 15, 35);

    // Date
    doc.setFont("Helvetica", "normal");
    doc.setFontSize(10);
    doc.text(dateOnly, 15, 41);

    // Invoice number (bold and slightly larger)
    doc.setFont("Helvetica", "bold");
    doc.setFontSize(11);
    doc.text(`Invoice: ${invoiceNumber}`, 15, 47);

    // Contact info (right aligned)
    doc.setFontSize(9);
    const addr = [
      "+855 88 5555 479",
      "mengjongmm99@gmail.com",
      "Phleung Chheh Roteh Lech, Sangkat Phleung Chheh Roteh",
      "Sangkat Phleung Chheh Roteh, Phnom Penh City, Cambodia"
    ];
    let ay = 12, ax = pw - 15;
    addr.forEach(line => { doc.text(line, ax, ay, { align: "right" }); ay += 5; });

    // Invoice title
    doc.setFont("Helvetica", "bold");
    doc.setFontSize(20);
    doc.text("INVOICE", pw / 2, 50, { align: "center" });

    // Divider line
    doc.setDrawColor(0); doc.setLineWidth(0.3);
    doc.line(25, 56, pw - 25, 56);

    // User info box
    const boxW = 100, boxH = 12, boxX = (pw - boxW) / 2, boxY = 62;
    doc.roundedRect(boxX, boxY, boxW, boxH, 2, 2);
    doc.setFontSize(12);
    doc.text(`User: ${playerId} (${zoneId})`, pw / 2, boxY + 8, { align: "center" });

    // Details table
    const desc = /weekly|monthly|pass/i.test(pkg) ? `${pkg} Pass` : /diamond/i.test(pkg) ? pkg : `${pkg} Diamonds`;
    doc.autoTable({
      head: [["Item", "Details"]],
      body: [
        ["Package", desc],
        ["Price", priceStr],
        ["Time", timeOnly],
        ["Status", "Successful"],
        ["Invoice No", invoiceNumber]
      ],
      startY: boxY + boxH + 10,
      tableWidth: 160,
      margin: { left: (pw - 160) / 2 },
      styles: { halign: "center", valign: "middle", fontSize: 11 },
      headStyles: { fillColor: [230,230,255], textColor: 0, fontStyle: "bold" },
      bodyStyles: { fillColor: [245,245,245] }
    });

    // Footer
    const footerY = doc.lastAutoTable.finalY + 15;
    doc.setFont("Helvetica", "normal");
    doc.setFontSize(9);
    doc.setTextColor(120);
    doc.text("Thank you for your purchase.", pw / 2, footerY, { align: "center" });

    // Save PDF
    doc.save(`invoice-${playerId}.pdf`);
  };
}
let returnSection = null;

function showTerms(fromSection = null) {
  returnSection = fromSection;

  document.getElementById('homepage').style.display = 'none';
  document.getElementById('mlTopupSection').style.display = 'none';
  document.getElementById('ffTopupSection').style.display = 'none';
  document.getElementById('termsSection').style.display = 'block';
  document.getElementById('buyNowBtn').style.display = 'none';

  const banner = document.querySelector('.home-banner');
  if (banner) banner.style.display = 'none';

  window.scrollTo(0, 0);
}

function hideTerms() {
  document.getElementById('termsSection').style.display = 'none';

  if (returnSection === 'ml') {
    document.getElementById('mlTopupSection').style.display = 'block';
    document.getElementById('buyNowBtn').style.display = 'block';
  } else if (returnSection === 'ff') {
    document.getElementById('ffTopupSection').style.display = 'block';
    document.getElementById('buyNowBtn').style.display = 'block';
  } else {
    document.getElementById('homepage').style.display = 'block';
    document.getElementById('mainFooter').style.display = 'block';
  }

  const banner = document.querySelector('.home-banner');
  if (banner) banner.style.display = 'block';

  window.scrollTo(0, 0);
}
</script>
</body>
</html>